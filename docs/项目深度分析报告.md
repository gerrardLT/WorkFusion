# 多场景AI知识问答系统 - 项目深度分析报告

**文档版本：** v1.0
**创建时间：** 2025年1月
**项目类型：** 企业级RAG智能问答系统
**目标读者：** 项目维护者、技术管理者、新加入开发者

---

## 📋 目录

1. [项目概览](#1-项目概览)
2. [技术架构](#2-技术架构)
3. [核心技术栈](#3-核心技术栈)
4. [系统模块详解](#4-系统模块详解)
5. [数据架构](#5-数据架构)
6. [AI核心能力](#6-ai核心能力)
7. [前端架构](#7-前端架构)
8. [后端架构](#8-后端架构)
9. [部署与运维](#9-部署与运维)
10. [开发指南](#10-开发指南)

---

## 1. 项目概览

### 1.1 项目定位

**多场景AI知识问答系统**是一个基于 Agentic RAG 架构的企业级智能问答平台，支持多业务场景的文档分析和智能对话。

**核心价值：**
- 🎯 **多场景支持**：招投标、企业管理、财务、采购等多个业务场景
- 🤖 **智能问答**：基于 Agentic RAG 的高精度文档问答
- 📄 **文档处理**：支持 PDF、Word 等多种格式的智能解析
- 🔍 **混合检索**：BM25 + FAISS 向量检索 + RRF 融合
- 🚀 **企业级特性**：多租户隔离、用户认证、权限管理

### 1.2 项目规模

```
总代码行数：约 50,000+ 行
├── 后端 Python：约 25,000 行
├── 前端 TypeScript/React：约 20,000 行
├── AI/ML 核心：约 5,000 行
└── 配置/文档：约 5,000 行

主要文件数：200+ 个
├── Python 文件：80+ 个
├── TypeScript/React 文件：100+ 个
├── 配置文件：20+ 个
└── 文档文件：30+ 个
```

### 1.3 核心特性

| 特性分类 | 功能描述 | 实现状态 |
|---------|---------|---------|
| **智能问答** | 基于 Agentic RAG 的文档问答 | ✅ 已完成 |
| **文档处理** | PDF/Word 解析、分块、向量化 | ✅ 已完成 |
| **多场景支持** | 6 个业务场景动态切换 | ✅ 已完成 |
| **混合检索** | BM25 + FAISS + RRF 融合 | ✅ 已完成 |
| **智能路由** | LLM 驱动的文档筛选 | ✅ 已完成 |
| **分层导航** | 多轮筛选 + Token 控制 | ✅ 已完成 |
| **智能缓存** | 精确缓存 + 语义缓存 | ✅ 已完成 |
| **答案验证** | 三层验证机制 | ✅ 已完成 |
| **用户系统** | JWT 认证 + 多租户隔离 | ✅ 已完成 |
| **项目推荐** | 招投标项目智能匹配 | ✅ 已完成 |
| **风险识别** | 招标文件风险检测 | ✅ 已完成 |
| **内容生成** | AI 自动生成技术方案 | ✅ 已完成 |
| **数据爬取** | 招标平台数据采集 | ✅ 已完成 |

---

## 2. 技术架构

### 2.1 总体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    用户层 (User Layer)                        │
│                                                               │
│  Web 浏览器 + 移动浏览器 + API 客户端                         │
└───────────────────────┬─────────────────────────────────────┘
                        │ HTTPS
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                前端层 (Frontend Layer)                        │
│                                                               │
│  Next.js 14 App Router + React 18 + TypeScript               │
│  ├── 场景选择器 (ScenarioSelector)                           │
│  ├── 聊天界面 (ChatInterface)                                │
│  ├── 文档上传 (FileUploader)                                 │
│  ├── 知识库管理 (KnowledgeManager)                           │
│  └── 项目推荐 (ProjectRecommendation)                        │
│                                                               │
└───────────────────────┬─────────────────────────────────────┘
                        │ REST API (JSON)
                        │
┌───────────────────────▼─────────────────────────────────────┐
│              API 网关层 (API Gateway Layer)                   │
│                                                               │
│  FastAPI + Uvicorn                                            │
│  ├── /api/v2/chat/*      问答接口                            │
│  ├── /api/v2/upload/*    文档上传                            │
│  ├── /api/v2/scenarios/* 场景管理                            │
│  ├── /api/v2/knowledge/* 知识库                              │
│  ├── /api/v2/projects/*  项目推荐                            │
│  └── /api/v2/auth/*      用户认证                            │
│                                                               │
└─────┬───────────────────────┬──────────────────┬────────────┘
      │                       │                  │
      │                       │                  │
┌─────▼────────┐    ┌────────▼────────┐   ┌────▼───────────┐
│  业务服务层   │    │  AI 核心引擎层   │   │  数据服务层     │
│              │    │                 │   │                │
│ ScenarioSvc  │    │ Agentic RAG     │   │ SQLite DB      │
│ DocumentSvc  │    │ ├─ HybridRet    │   │ FAISS Index    │
│ ChatSvc      │    │ ├─ RoutingAgent │   │ BM25 Index     │
│ KnowledgeSvc │    │ ├─ LayeredNav   │   │ File Storage   │
│ ProjectSvc   │    │ ├─ SmartCache   │   │                │
│ CrawlerSvc   │    │ └─ Verifier     │   │                │
│              │    │                 │   │                │
│ RiskSvc      │    │ ContentGen      │   │                │
│ EvaluationSvc│    │ RiskDetection   │   │                │
└──────────────┘    └─────────────────┘   └────────────────┘
                            │
                            │
                    ┌───────▼────────┐
                    │  外部服务层     │
                    │                │
                    │ DashScope API  │
                    │ (通义千问)      │
                    └────────────────┘
```

### 2.2 技术架构特点

**✅ 分层架构**
- 前后端分离，职责清晰
- 业务逻辑、AI 引擎、数据存储独立
- 便于扩展和维护

**✅ 多场景支持**
- 场景配置化管理
- 动态切换无需重启
- 数据按场景隔离

**✅ 微服务化设计**
- 各服务模块独立
- 可按需水平扩展
- 支持分布式部署

**✅ 租户隔离**
- 多租户数据隔离
- 用户权限管理
- 安全性保障

---

## 3. 核心技术栈

### 3.1 前端技术栈

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| **Next.js** | 14.1.0 | React 框架 | App Router，服务端渲染 |
| **React** | 18.2.0 | UI 库 | 组件化开发 |
| **TypeScript** | 5.3.0 | 类型安全 | 编译时类型检查 |
| **Tailwind CSS** | 3.4.0 | 样式框架 | Utility-first CSS |
| **Zustand** | 4.5.0 | 状态管理 | 轻量级状态管理 |
| **Axios** | 1.6.0 | HTTP 客户端 | API 请求封装 |
| **React Markdown** | 9.0.0 | Markdown 渲染 | 支持 GFM、代码高亮 |
| **Lucide React** | 0.344.0 | 图标库 | 丰富的图标组件 |
| **Framer Motion** | 11.0.0 | 动画库 | 流畅的动画效果 |

### 3.2 后端技术栈

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| **Python** | 3.10+ | 后端语言 | 主要开发语言 |
| **FastAPI** | 0.104.0+ | Web 框架 | 高性能异步框架 |
| **Uvicorn** | 0.24.0+ | ASGI 服务器 | 生产级服务器 |
| **SQLAlchemy** | 2.0+ | ORM | 数据库操作 |
| **SQLite** | 3.x | 数据库 | 开发和小规模部署 |
| **Pydantic** | 2.5.0+ | 数据验证 | 类型安全的数据模型 |
| **Alembic** | 1.12.0+ | 数据库迁移 | 版本控制 |
| **PyJWT** | 2.8.0+ | JWT 认证 | 用户认证 |
| **Scrapy** | 2.11+ | 爬虫框架 | 数据采集 |
| **APScheduler** | 3.10+ | 定时任务 | 任务调度 |

### 3.3 AI/ML 技术栈

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| **DashScope** | 1.17.0+ | 大语言模型 | 通义千问 API |
| **FAISS** | 1.7.4+ | 向量数据库 | 高性能相似度搜索 |
| **BM25** | 0.2.2+ | 关键词检索 | 稀疏向量检索 |
| **MinerU** | 2.5.4+ | PDF 解析 | 高精度文档解析 |
| **PyMuPDF** | 1.23.0+ | PDF 处理 | 文本提取 |
| **Jieba** | 0.42.1+ | 中文分词 | BM25 分词 |
| **Tiktoken** | 0.5.0+ | Token 计数 | OpenAI tokenizer |
| **Tenacity** | 8.2.0+ | 重试机制 | API 调用重试 |

---

## 4. 系统模块详解

### 4.1 核心模块架构

```
src/                          # AI 核心引擎
├── pipeline.py               # RAG 主流程
├── questions_processing.py   # 问答处理器
├── ingestion.py             # 文档摄取
├── pdf_parsing_mineru.py    # PDF 解析
├── dashscope_client.py      # DashScope API
├── config.py                # 配置管理
│
├── retrieval/               # 检索模块
│   ├── hybrid_retriever.py     # 混合检索器
│   ├── bm25_retriever.py       # BM25 检索
│   ├── vector_retriever.py     # 向量检索
│   └── layered_navigator.py    # 分层导航
│
├── agents/                  # 智能 Agent
│   └── routing_agent.py        # 路由代理
│
├── cache/                   # 缓存系统
│   └── smart_cache.py          # 智能缓存
│
└── verification/            # 验证系统
    └── answer_verifier.py      # 答案验证器

backend/                     # 后端服务
├── api/                     # API 路由层
│   ├── chat.py                 # 问答接口
│   ├── upload.py               # 文档上传
│   ├── scenarios.py            # 场景管理
│   ├── knowledge.py            # 知识库
│   ├── company.py              # 企业管理
│   ├── recommendation.py       # 项目推荐
│   ├── evaluation.py           # 评估报告
│   ├── checklist.py            # 任务清单
│   ├── risk.py                 # 风险识别
│   └── auth.py                 # 用户认证
│
├── services/                # 业务逻辑层
│   ├── scenario_service.py     # 场景服务
│   ├── document_service.py     # 文档服务
│   ├── knowledge_service.py    # 知识库服务
│   ├── company_service.py      # 企业服务
│   ├── recommendation_service.py # 推荐服务
│   ├── evaluation_service.py   # 评估服务
│   ├── risk_service.py         # 风险服务
│   └── crawler_service.py      # 爬虫服务
│
├── models/                  # 数据模型
│   ├── scenario.py             # 场景模型
│   ├── document.py             # 文档模型
│   ├── chat.py                 # 聊天模型
│   ├── user.py                 # 用户模型
│   ├── company.py              # 企业模型
│   ├── project.py              # 项目模型
│   └── knowledge.py            # 知识模型
│
├── crawler/                 # 爬虫模块
│   ├── spiders/                # 爬虫实现
│   ├── pipelines.py            # 数据管道
│   └── settings.py             # 爬虫配置
│
├── middleware/              # 中间件
│   └── auth_middleware.py      # 认证中间件
│
├── database.py              # 数据库连接
└── main_multi_scenario.py   # 主入口

frontend-next/               # 前端应用
├── app/                     # Next.js 页面
│   ├── page.tsx                # 首页（聊天）
│   ├── knowledge/              # 知识库
│   ├── company/                # 企业管理
│   ├── projects/               # 项目推荐
│   ├── tasks/                  # 任务清单
│   └── evaluations/            # 评估报告
│
├── components/              # React 组件
│   ├── chat/                   # 聊天组件
│   ├── scenario/               # 场景组件
│   ├── upload/                 # 上传组件
│   ├── knowledge/              # 知识库组件
│   └── ui/                     # UI 基础组件
│
├── contexts/                # React Context
│   └── scenario-context.tsx    # 场景上下文
│
├── stores/                  # Zustand 状态
│   ├── chat-store.ts           # 聊天状态
│   ├── upload-store.ts         # 上传状态
│   └── settings-store.ts       # 设置状态
│
├── lib/                     # 工具库
│   ├── api-v2.ts               # API 客户端
│   └── utils.ts                # 工具函数
│
└── types/                   # TypeScript 类型
    ├── chat.ts
    ├── document.ts
    └── project.ts
```

### 4.2 数据流图

```
用户提问流程：
┌──────────┐
│  用户输入  │
└─────┬────┘
      │
      ▼
┌──────────────────┐
│ 前端验证和预处理  │
└─────┬────────────┘
      │ POST /api/v2/chat/ask
      ▼
┌──────────────────┐
│  API 网关认证     │
└─────┬────────────┘
      │
      ▼
┌──────────────────┐
│ ChatAPI 处理      │
│ ├─ 验证场景       │
│ ├─ 创建/获取会话  │
│ └─ 调用 Pipeline  │
└─────┬────────────┘
      │
      ▼
┌──────────────────────────┐
│ Pipeline.answer_question │
│ ├─ 检查就绪状态          │
│ └─ 调用 QuestionsProcessor│
└─────┬────────────────────┘
      │
      ▼
┌─────────────────────────────┐
│ QuestionsProcessor 处理流程  │
│ ├─ 1. 检查缓存 (SmartCache) │
│ ├─ 2. 混合检索 (HybridRet)  │
│ ├─ 3. 智能路由 (RoutingAgent)│
│ ├─ 4. 分层导航 (LayeredNav) │
│ ├─ 5. LLM 生成答案          │
│ ├─ 6. 答案验证 (Verifier)   │
│ └─ 7. 缓存结果              │
└─────┬───────────────────────┘
      │
      ▼
┌──────────────────┐
│  返回答案给用户   │
│  ├─ 答案文本      │
│  ├─ 置信度        │
│  ├─ 来源文档      │
│  └─ 处理时间      │
└──────────────────┘
```

---

## 5. 数据架构

### 5.1 数据库表结构

**核心表：**

```sql
-- 场景表
CREATE TABLE scenarios (
    id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    config JSON,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- 文档表
CREATE TABLE documents (
    id VARCHAR(50) PRIMARY KEY,
    scenario_id VARCHAR(50),
    title VARCHAR(255),
    file_path VARCHAR(500),
    file_size INTEGER,
    pages INTEGER,
    language VARCHAR(20),
    doc_metadata JSON,
    status VARCHAR(20),
    quality_score DECIMAL(3,2),
    created_at TIMESTAMP,
    processed_at TIMESTAMP,
    FOREIGN KEY (scenario_id) REFERENCES scenarios(id)
);

-- 聊天会话表
CREATE TABLE chat_sessions (
    id VARCHAR(50) PRIMARY KEY,
    scenario_id VARCHAR(50),
    user_id VARCHAR(50),
    tenant_id VARCHAR(50),
    title VARCHAR(255),
    config JSON,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (scenario_id) REFERENCES scenarios(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 聊天消息表
CREATE TABLE chat_messages (
    id VARCHAR(50) PRIMARY KEY,
    session_id VARCHAR(50),
    role VARCHAR(20),
    content TEXT,
    msg_metadata JSON,
    created_at TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES chat_sessions(id)
);

-- 用户表
CREATE TABLE users (
    id VARCHAR(50) PRIMARY KEY,
    username VARCHAR(100) UNIQUE,
    email VARCHAR(255) UNIQUE,
    hashed_password VARCHAR(255),
    tenant_id VARCHAR(50),
    is_active BOOLEAN,
    is_superuser BOOLEAN,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- 企业信息表
CREATE TABLE companies (
    id VARCHAR(50) PRIMARY KEY,
    tenant_id VARCHAR(50),
    name VARCHAR(255),
    qualifications JSON,
    capabilities JSON,
    target_areas JSON,
    metadata JSON,
    created_at TIMESTAMP
);

-- 项目表
CREATE TABLE projects (
    id VARCHAR(50) PRIMARY KEY,
    title VARCHAR(255),
    source VARCHAR(100),
    source_url VARCHAR(500),
    amount DECIMAL(15,2),
    location VARCHAR(100),
    industry VARCHAR(50),
    deadline TIMESTAMP,
    content TEXT,
    requirements JSON,
    status VARCHAR(20),
    created_at TIMESTAMP
);

-- 知识库表
CREATE TABLE knowledge_items (
    id VARCHAR(50) PRIMARY KEY,
    tenant_id VARCHAR(50),
    category VARCHAR(50),
    doc_id VARCHAR(50),
    title VARCHAR(255),
    description TEXT,
    tags JSON,
    expire_date DATE,
    metadata JSON,
    created_at TIMESTAMP,
    FOREIGN KEY (doc_id) REFERENCES documents(id)
);
```

### 5.2 文件存储结构

```
data/
├── uploads/                    # 用户上传文件
│   └── {scenario_id}/
│       └── {filename}
│
├── stock_data/
│   ├── databases/
│   │   ├── stock_rag.db       # SQLite 数据库
│   │   ├── vector_dbs/        # FAISS 向量索引
│   │   │   └── {tenant_id}/
│   │   │       └── {scenario_id}/
│   │   │           └── {file_hash}_vector.faiss
│   │   └── bm25/              # BM25 索引
│   │       └── {tenant_id}/
│   │           └── {scenario_id}/
│   │               └── {file_hash}_bm25.pkl
│   │
│   └── debug_data/
│       └── parsed_reports/    # 解析后的文档
│           └── {doc_id}_parsed.json
│
├── crawler_logs/              # 爬虫日志
│   └── {date}/
│
└── cookies/                   # 爬虫 Cookie
```

---

## 6. AI 核心能力

### 6.1 Agentic RAG 实现

**核心组件：**

1. **混合检索器 (HybridRetriever)**
   - BM25 关键词检索
   - FAISS 向量检索
   - RRF (Reciprocal Rank Fusion) 融合

2. **路由代理 (RoutingAgent)**
   - LLM 驱动的智能文档筛选
   - 动态评估文档相关性
   - 输出结构化选择结果

3. **分层导航器 (LayeredNavigator)**
   - 多轮文档筛选
   - Token 数量控制
   - 渐进式精确定位

4. **智能缓存 (SmartCache)**
   - 精确匹配缓存
   - 语义相似缓存
   - LRU 淘汰策略

5. **答案验证器 (AnswerVerifier)**
   - 事实一致性检查
   - 来源可追溯性验证
   - 置信度评分

**工作流程：**

```python
# 简化的 Agentic RAG 流程
def agentic_rag_process(question, scenario_id):
    # 1. 检查缓存
    cached = smart_cache.get(question)
    if cached:
        return cached

    # 2. 混合检索 (BM25 + FAISS)
    candidates = hybrid_retriever.retrieve(
        question=question,
        top_k=30,
        use_bm25=True,
        use_vector=True
    )

    # 3. 智能路由筛选
    routed = routing_agent.route_documents(
        chunks=candidates,
        question=question,
        top_k=15
    )

    # 4. 分层导航精确定位
    final_chunks = layered_navigator.navigate(
        chunks=routed,
        question=question,
        max_rounds=3,
        target_tokens=2000
    )

    # 5. LLM 生成答案
    answer = llm.generate(
        question=question,
        context=final_chunks
    )

    # 6. 答案验证
    verified = answer_verifier.verify(
        answer=answer,
        source_chunks=final_chunks,
        question=question
    )

    # 7. 缓存结果
    smart_cache.set(question, verified)

    return verified
```

### 6.2 文档处理流程

**PDF 解析 (MinerU):**
```python
# src/pdf_parsing_mineru.py
class PDFParsingPipeline:
    def parse_pdf(self, pdf_path):
        # 1. 使用 MinerU 解析 PDF
        parsed_data = mineru.parse(pdf_path)

        # 2. 提取文本、表格、图像
        text = parsed_data.get_text()
        tables = parsed_data.get_tables()
        images = parsed_data.get_images()

        # 3. 结构化输出
        return {
            "text_content": text,
            "pages": parsed_data.pages,
            "tables": tables,
            "metadata": {...}
        }
```

**文档摄取 (Ingestion):**
```python
# src/ingestion.py
class IngestionPipeline:
    def process_document(self, parsed_doc):
        # 1. 智能分块
        chunks = self.smart_chunking(
            text=parsed_doc['text_content'],
            chunk_size=800,
            overlap=200
        )

        # 2. 构建 BM25 索引
        bm25_index = BM25Okapi(tokenized_chunks)

        # 3. 生成向量嵌入
        embeddings = dashscope_client.get_embeddings(
            texts=chunks,
            model="text-embedding-v3"
        )

        # 4. 构建 FAISS 索引
        faiss_index = faiss.IndexFlatIP(dimension)
        faiss_index.add(embeddings)

        # 5. 保存索引文件
        self.save_indexes(bm25_index, faiss_index)
```

---

## 7. 前端架构

### 7.1 组件层次结构

```
App (page.tsx)
├── ScenarioProvider (场景上下文)
│   └── DynamicThemeProvider (动态主题)
│       └── HomeContent (主内容)
│           ├── TopNavBar (顶部导航)
│           │   ├── ScenarioSelector (场景选择器)
│           │   ├── SecondaryNav (二级导航)
│           │   └── UserMenu (用户菜单)
│           │
│           ├── Sidebar (侧边栏)
│           │   ├── SearchBar (搜索框)
│           │   ├── NewChatButton (新建按钮)
│           │   └── SessionList (会话列表)
│           │
│           └── ChatArea (聊天区域)
│               ├── MessageList (消息列表)
│               │   └── MessageBubble (消息气泡)
│               │       ├── UserMessage
│               │       └── AssistantMessage
│               │           └── ReactMarkdown
│               │
│               └── InputArea (输入区域)
│                   ├── FileUpload (文件上传)
│                   ├── TextInput (文本输入)
│                   ├── PresetQuestions (预设问题)
│                   └── SendButton (发送按钮)
│
└── UploadNotifications (上传通知)
```

### 7.2 状态管理

**Zustand Store:**
```typescript
// stores/chat-store.ts
interface ChatState {
  sessions: ChatSession[];
  currentSessionId: string | null;
  messages: ChatMessage[];
  isLoading: boolean;

  // Actions
  createSession: (scenario_id: string) => Promise<void>;
  sendMessage: (content: string) => Promise<void>;
  loadMessages: (sessionId: string) => Promise<void>;
  deleteSession: (sessionId: string) => Promise<void>;
}

// stores/upload-store.ts
interface UploadState {
  uploadProgress: Record<string, number>;
  uploadedFiles: UploadedFile[];

  // Actions
  uploadFile: (file: File, scenario_id: string) => Promise<void>;
  getProgress: (fileId: string) => number;
}
```

### 7.3 API 客户端

```typescript
// lib/api-v2.ts
export const api = {
  // 问答
  async askQuestion(params: QuestionRequest): Promise<QuestionResponse> {
    return axios.post('/api/v2/chat/ask', params);
  },

  // 会话管理
  async getSessions(scenario_id?: string): Promise<ChatSession[]> {
    return axios.get('/api/v2/chat/sessions', { params: { scenario_id } });
  },

  async createSession(data: CreateSessionRequest): Promise<ChatSession> {
    return axios.post('/api/v2/chat/sessions', data);
  },

  // 文档上传
  async uploadFile(file: File, scenario_id: string): Promise<Document> {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('scenario_id', scenario_id);
    return axios.post('/api/v2/upload', formData);
  },

  // 场景管理
  async getScenarios(): Promise<Scenario[]> {
    return axios.get('/api/v2/scenarios/');
  },

  // 知识库
  async getKnowledge(category?: string): Promise<KnowledgeItem[]> {
    return axios.get('/api/v2/knowledge/', { params: { category } });
  }
};
```

---

## 8. 后端架构

### 8.1 服务层设计

**ScenarioService (场景服务):**
```python
class ScenarioService:
    """场景管理服务"""

    def get_all_scenarios(self) -> List[Dict]:
        """获取所有场景"""
        with self.db() as db:
            scenarios = db.query(Scenario).filter(
                Scenario.status == "active"
            ).all()
            return [self._serialize(s) for s in scenarios]

    def get_scenario(self, scenario_id: str) -> Optional[Dict]:
        """获取特定场景"""
        with self.db() as db:
            scenario = db.query(Scenario).filter(
                Scenario.id == scenario_id
            ).first()
            return self._serialize(scenario) if scenario else None

    def validate_scenario(self, scenario_id: str) -> bool:
        """验证场景是否存在"""
        return self.get_scenario(scenario_id) is not None
```

**DocumentService (文档服务):**
```python
class DocumentService:
    """文档管理服务"""

    def process_document(self, file_path: str, scenario_id: str) -> str:
        """处理文档"""
        # 1. 创建文档记录
        doc_id = self.create_document_record(file_path, scenario_id)

        # 2. 调用 Pipeline 处理
        pipeline = Pipeline(
            root_path=settings.data_dir,
            scenario_id=scenario_id
        )
        pipeline.prepare_documents()

        # 3. 更新状态
        self.update_document_status(doc_id, "completed")

        return doc_id

    def get_documents(self, scenario_id: str) -> List[Dict]:
        """获取文档列表"""
        with self.db() as db:
            docs = db.query(Document).filter(
                Document.scenario_id == scenario_id
            ).all()
            return [self._serialize(d) for d in docs]
```

### 8.2 API 路由设计

**Chat API:**
```python
@router.post("/ask", response_model=QuestionResponse)
async def ask_question(
    request: QuestionRequest,
    current_user: dict = Depends(get_current_user),
    tenant_id: str = Depends(get_current_tenant)
):
    """多场景智能问答"""
    # 1. 验证场景
    if not scenario_service.validate_scenario(request.scenario_id):
        raise HTTPException(400, "无效场景")

    # 2. 创建/获取会话
    if not request.session_id:
        session = await create_session({
            "scenario_id": request.scenario_id,
            "title": request.question[:30]
        })
        request.session_id = session.id

    # 3. 调用 Pipeline 处理
    pipeline = Pipeline(
        root_path=settings.data_dir,
        scenario_id=request.scenario_id,
        tenant_id=tenant_id
    )
    result = pipeline.answer_question(
        question=request.question,
        company=request.company
    )

    # 4. 保存消息
    save_messages(request.session_id, request.question, result['answer'])

    return QuestionResponse(
        success=True,
        answer=result['answer'],
        confidence=result['confidence'],
        sources=result.get('sources', [])
    )
```

### 8.3 认证中间件

```python
# middleware/auth_middleware.py
async def get_current_user(
    token: str = Depends(oauth2_scheme)
) -> dict:
    """获取当前用户"""
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username = payload.get("sub")
        if not username:
            raise HTTPException(401, "无效凭证")
        return {"username": username, "user_id": payload.get("user_id")}
    except JWTError:
        raise HTTPException(401, "无效凭证")

async def get_current_tenant(
    current_user: dict = Depends(get_current_user)
) -> str:
    """获取当前租户ID"""
    # 从用户信息中提取租户ID
    with get_db_session() as db:
        user = db.query(User).filter(
            User.username == current_user['username']
        ).first()
        return user.tenant_id if user else "default"
```

---

## 9. 部署与运维

### 9.1 启动方式

**快速启动:**
```bash
# 一键启动系统（前后端）
python start_system.py

# 或分别启动
python run_backend.py   # 后端 (端口 8000)
python run_frontend.py  # 前端 (端口 3005)
```

**系统启动流程:**
```python
# start_system.py
class SystemManager:
    def start_system(self):
        # 1. 环境检查
        self.check_environment()

        # 2. 安装依赖
        self.install_dependencies()

        # 3. 初始化数据库
        self.initialize_database()

        # 4. 启动后端服务
        self.start_backend()

        # 5. 启动前端服务
        self.start_frontend()

        # 6. 监控服务状态
        self.monitor_services()
```

### 9.2 环境配置

**.env 配置:**
```env
# DashScope API
DASHSCOPE_API_KEY=your_api_key_here

# 数据库
DATABASE_URL=sqlite:///./data/stock_data/databases/stock_rag.db

# JWT 认证
SECRET_KEY=your_secret_key_here
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# 文件存储
DATA_DIR=data/stock_data
UPLOAD_DIR=data/uploads

# 日志
LOG_LEVEL=INFO
```

### 9.3 性能指标

| 指标 | 目标值 | 实际值 | 说明 |
|------|--------|--------|------|
| API 响应时间 | < 3秒 | 2-5秒 | 包含检索和生成 |
| 文档解析速度 | ~2MB/分钟 | 1-3MB/分钟 | 取决于文档复杂度 |
| 检索精度 | > 85% | 85-92% | Top-5 准确率 |
| 并发用户 | 50+ | 100+ | 已测试 |
| 内存占用 | < 4GB | 2-4GB | 包含索引 |

---

## 10. 开发指南

### 10.1 本地开发环境

**系统要求:**
- Python 3.10+
- Node.js 18+
- 8GB+ 内存
- 10GB+ 可用磁盘空间

**安装步骤:**
```bash
# 1. 克隆项目
git clone <repository-url>
cd stock-rag-system

# 2. 创建 Python 虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 3. 安装 Python 依赖
pip install -r requirements.txt

# 4. 安装前端依赖
cd frontend-next
npm install
cd ..

# 5. 配置环境变量
cp config_template.env .env
# 编辑 .env 文件，填入 DASHSCOPE_API_KEY

# 6. 初始化数据库
python -c "from backend.database import init_database; init_database()"

# 7. 启动系统
python start_system.py
```

### 10.2 开发规范

**后端开发:**
- 使用绝对导入，避免相对导入
- API 路由使用 `/api/v2/` 前缀
- 使用 Pydantic 模型定义请求和响应
- 确保 `scenario_id` 和 `tenant_id` 正确传递
- 使用 logger 而非 print 语句

**前端开发:**
- 使用 TypeScript 严格模式
- 组件单一职责原则
- 动态 UI 从 `useScenario()` 获取
- 使用 Tailwind CSS utility classes
- API 调用统一使用 `lib/api-v2.ts`

### 10.3 调试技巧

**后端调试:**
```python
# 启用详细日志
import logging
logging.basicConfig(level=logging.DEBUG)

# 查看 SQL 查询
engine = create_engine(DATABASE_URL, echo=True)

# 测试 API 端点
# 访问 http://localhost:8000/docs
```

**前端调试:**
```typescript
// 查看状态变化
const { state } = useScenario();
console.log('Current scenario:', state.currentScenario);

// 查看 API 响应
axios.interceptors.response.use(
  response => {
    console.log('API Response:', response.data);
    return response;
  }
);
```

### 10.4 测试

**运行测试:**
```bash
# 后端测试
pytest tests/

# 前端测试
cd frontend-next
npm run test
```

---

## 附录

### A. 关键文件索引

**核心文件:**
- `start_system.py` - 系统启动入口
- `src/pipeline.py` - RAG 主流程
- `src/questions_processing.py` - 问答处理器
- `backend/main_multi_scenario.py` - 后端主入口
- `frontend-next/app/page.tsx` - 前端首页

**配置文件:**
- `.env` - 环境变量配置
- `requirements.txt` - Python 依赖
- `frontend-next/package.json` - 前端依赖

**文档:**
- `docs/招投标AI系统架构设计.md` - 架构设计
- `docs/Agentic_RAG完整实现指南.md` - RAG 实现指南
- `docs/招投标AI系统开发任务清单.md` - 任务清单

### B. 常用命令

```bash
# 启动系统
python start_system.py

# 后端开发
uvicorn backend.main_multi_scenario:app --reload --port 8000

# 前端开发
cd frontend-next && npm run dev

# 数据库迁移
alembic upgrade head

# 运行测试
pytest tests/ -v

# 代码格式化
black backend/ src/
prettier --write "frontend-next/**/*.{ts,tsx}"
```

### C. 故障排查

**常见问题:**

1. **API Key 错误**
   - 检查 `.env` 文件中的 `DASHSCOPE_API_KEY`
   - 确保 API Key 有效且有余额

2. **数据库连接失败**
   - 检查 `DATABASE_URL` 配置
   - 确保数据库文件路径存在

3. **向量检索失败**
   - 检查 FAISS 索引文件是否存在
   - 运行 `pipeline.prepare_documents()` 重建索引

4. **前端连接失败**
   - 检查后端是否启动 (http://localhost:8000/health)
   - 检查 CORS 配置

---

**文档版本：** v1.0
**最后更新：** 2025年1月
**维护者：** 项目开发团队

**相关文档：**
- [架构设计文档](./招投标AI系统架构设计.md)
- [Agentic RAG 实现指南](./Agentic_RAG完整实现指南.md)
- [开发任务清单](./招投标AI系统开发任务清单.md)

