# ç”¨æˆ·ç³»ç»Ÿå®Œæ•´å¼€å‘æ€»ç»“

## ğŸ‰ é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**: å¤šåœºæ™¯AIçŸ¥è¯†é—®ç­”ç³»ç»Ÿ - ç”¨æˆ·è®¤è¯ä¸å¤šç§Ÿæˆ·ç³»ç»Ÿ
**å¼€å‘å‘¨æœŸ**: 2025-10-16
**å¼€å‘çŠ¶æ€**: âœ… **æ ¸å¿ƒåŠŸèƒ½å…¨éƒ¨å®Œæˆ**
**ç³»ç»Ÿç‰ˆæœ¬**: v2.0.0

## ğŸ“Š å¼€å‘æˆæœæ€»è§ˆ

### å®Œæˆåº¦ç»Ÿè®¡

| æ¨¡å— | å­é¡¹ | çŠ¶æ€ | å®Œæˆåº¦ |
|------|------|------|--------|
| **åç«¯åŸºç¡€æ¶æ„** | æ•°æ®åº“æ¨¡å‹ | âœ… å®Œæˆ | 100% |
| | è®¤è¯æœåŠ¡ | âœ… å®Œæˆ | 100% |
| | è®¤è¯ä¸­é—´ä»¶ | âœ… å®Œæˆ | 100% |
| | è®¤è¯APIè·¯ç”± | âœ… å®Œæˆ | 100% |
| **åç«¯APIæ”¹é€ ** | Chat API | âœ… å®Œæˆ | 100% |
| | Upload API | âœ… å®Œæˆ | 100% |
| | Knowledge API | âœ… å®Œæˆ | 100% |
| | Company API | âœ… å®Œæˆ | 100% |
| | Recommendation API | âœ… å®Œæˆ | 100% |
| **Pipelineå±‚** | ç§Ÿæˆ·çº§ç´¢å¼•éš”ç¦» | âœ… å®Œæˆ | 100% |
| | æ•°æ®è¿ç§»è„šæœ¬ | âœ… å®Œæˆ | 100% |
| **å‰ç«¯è®¤è¯** | ç™»å½•/æ³¨å†Œé¡µé¢ | âœ… å®Œæˆ | 100% |
| | OAuthå›è°ƒå¤„ç† | âœ… å®Œæˆ | 100% |
| | APIå®¢æˆ·ç«¯æ”¹é€  | âœ… å®Œæˆ | 100% |
| | è·¯ç”±å®ˆå« | âœ… å®Œæˆ | 100% |
| | ç”¨æˆ·ä¸­å¿ƒ | âœ… å®Œæˆ | 100% |
| **OAuthé›†æˆ** | æ¡†æ¶ç»“æ„ | âœ… å®Œæˆ | 100% |
| | å¾®ä¿¡OAuth | â³ å¾…é…ç½® | 80% |
| | é’‰é’‰OAuth | â³ å¾…é…ç½® | 80% |
| | æ‰‹æœºå·ç™»å½• | â³ å¾…é…ç½® | 80% |

**æ€»ä½“å®Œæˆåº¦**: **95%** ğŸ¯

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯åº”ç”¨å±‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ ç™»å½•é¡µé¢ â”‚  â”‚OAuthå›è°ƒ â”‚  â”‚ç”¨æˆ·ä¸­å¿ƒ  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚
â”‚       â”‚             â”‚              â”‚                     â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                     â”‚                                    â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚            â”‚   APIå®¢æˆ·ç«¯     â”‚  (Tokenç®¡ç† + è‡ªåŠ¨åˆ·æ–°) â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ HTTP + JWT Token
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åç«¯APIå±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         è®¤è¯ä¸­é—´ä»¶ (JWTéªŒè¯ + ç§Ÿæˆ·è¯†åˆ«)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚
â”‚       â”‚           â”‚          â”‚          â”‚       â”‚       â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”  â”‚
â”‚  â”‚Chat APIâ”‚  â”‚Upload â”‚  â”‚Knowledgeâ”‚Companyâ”‚ â”‚...â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”¬â”€â”€â”˜  â”‚
â”‚       â”‚          â”‚          â”‚         â”‚       â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜
        â”‚          â”‚          â”‚         â”‚       â”‚
        â”‚          â”‚          â”‚         â”‚       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚                  ä¸šåŠ¡é€»è¾‘å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ AuthService  â”‚  â”‚  å…¶ä»–Service  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®å±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   SQLiteæ•°æ®åº“   â”‚  â”‚  å‘é‡/BM25ç´¢å¼•ï¼ˆç§Ÿæˆ·çº§ï¼‰ â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Tenant     â”‚  â”‚  â”‚  â”‚ vector_dbs/       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ User       â”‚  â”‚  â”‚  â”‚  â””â”€default/       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Role       â”‚  â”‚  â”‚  â”‚     â””â”€tender/     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ChatSessionâ”‚  â”‚  â”‚  â”‚     â””â”€enterprise/ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Document   â”‚  â”‚  â”‚  â”‚ bm25/             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ...        â”‚  â”‚  â”‚  â”‚  â””â”€default/       â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæŠ€æœ¯æ ˆ

#### åç«¯
- **æ¡†æ¶**: FastAPI 0.115.6
- **ORM**: SQLAlchemy 2.0.40
- **æ•°æ®åº“**: SQLite
- **è®¤è¯**: JWT (pyjwt 2.10.1) + bcrypt 4.3.0
- **OAuth**: authlib 1.6.1 + httpx 0.27.2
- **å‘é‡æ£€ç´¢**: FAISS 1.9.0
- **å…³é”®è¯æ£€ç´¢**: BM25Okapi

#### å‰ç«¯
- **æ¡†æ¶**: Next.js 14 (App Router)
- **UI**: React 18 + TypeScript + Tailwind CSS
- **HTTPå®¢æˆ·ç«¯**: Axios
- **çŠ¶æ€ç®¡ç†**: Zustand + React Context

## ğŸ” æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### 1. ç”¨æˆ·è®¤è¯ç³»ç»Ÿ

#### è®¤è¯æ–¹å¼
| æ–¹å¼ | çŠ¶æ€ | æè¿° |
|------|------|------|
| ç”¨æˆ·å/å¯†ç  | âœ… å®Œæˆ | bcryptåŠ å¯†ï¼ŒJWT Tokenè®¤è¯ |
| å¾®ä¿¡OAuth | â³ æ¡†æ¶å®Œæˆ | éœ€é…ç½®APP_IDå’ŒAPP_SECRET |
| é’‰é’‰OAuth | â³ æ¡†æ¶å®Œæˆ | éœ€é…ç½®APP_IDå’ŒAPP_SECRET |
| æ‰‹æœºå·éªŒè¯ç  | â³ æ¡†æ¶å®Œæˆ | éœ€é…ç½®çŸ­ä¿¡æœåŠ¡ |

#### Tokenç­–ç•¥
- **Access Token**: æœ‰æ•ˆæœŸ2å°æ—¶ï¼Œå­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- **Refresh Token**: æœ‰æ•ˆæœŸ7å¤©ï¼Œç”¨äºåˆ·æ–°Access Token
- **è‡ªåŠ¨åˆ·æ–°**: å‰ç«¯æ‹¦æˆªå™¨è‡ªåŠ¨æ£€æµ‹401å¹¶åˆ·æ–°Token

### 2. å¤šç§Ÿæˆ·éš”ç¦»

#### æ•°æ®éš”ç¦»å±‚çº§

**ç§Ÿæˆ·çº§éš”ç¦»ï¼ˆå®Œå…¨éš”ç¦»ï¼‰**
- âœ… ä¼šè¯ï¼ˆChatSessionï¼‰- æŒ‰tenant_idéš”ç¦»
- âœ… æ¶ˆæ¯ï¼ˆChatMessageï¼‰- ç»§æ‰¿ä¼šè¯éš”ç¦»
- âœ… æ–‡æ¡£ï¼ˆDocumentï¼‰- æŒ‰tenant_idéš”ç¦»
- âœ… å‘é‡ç´¢å¼• - ç‹¬ç«‹ç›®å½•ï¼š`vector_dbs/{tenant_id}/{scenario_id}/`
- âœ… BM25ç´¢å¼• - ç‹¬ç«‹ç›®å½•ï¼š`bm25/{tenant_id}/{scenario_id}/`

**å…±äº«æ•°æ®ï¼ˆå…¨å±€ï¼‰**
- âœ… åœºæ™¯é…ç½®ï¼ˆScenarioï¼‰
- âœ… ç³»ç»Ÿé¢„è®¾é—®é¢˜

**å¯é…ç½®å…±äº«**
- âœ… çŸ¥è¯†åº“ï¼ˆKnowledgeï¼‰- æ”¯æŒpublic/privateæ ‡è®°
- âœ… å…¬å¸åº“ï¼ˆCompanyï¼‰- é€šè¿‡config.data_sharingé…ç½®
- âœ… é¡¹ç›®åº“ï¼ˆProjectï¼‰- é€šè¿‡config.data_sharingé…ç½®

### 3. æƒé™ç®¡ç†ï¼ˆRBACï¼‰

#### åˆå§‹è§’è‰²

**ç®¡ç†å‘˜ï¼ˆadminï¼‰**
```json
{
  "chat": ["create", "read", "update", "delete"],
  "document": ["upload", "read", "delete"],
  "knowledge": ["create", "read", "update", "delete"],
  "report": ["generate", "read", "export"],
  "user": ["create", "read", "update", "delete"],
  "tenant": ["read", "update"]
}
```

**æ™®é€šç”¨æˆ·ï¼ˆuserï¼‰**
```json
{
  "chat": ["create", "read", "update", "delete"],
  "document": ["upload", "read"],
  "knowledge": ["read"],
  "report": ["read"]
}
```

#### å¯æ‰©å±•è§’è‰²ï¼ˆé¢„ç•™ï¼‰
- editorï¼ˆç¼–è¾‘ï¼‰
- viewerï¼ˆæŸ¥çœ‹ï¼‰
- analystï¼ˆåˆ†æå¸ˆï¼‰

## ğŸ“ æ ¸å¿ƒæ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶

#### æ•°æ®æ¨¡å‹
- `backend/models/user.py` - ç”¨æˆ·ã€ç§Ÿæˆ·ã€è§’è‰²ã€OAuthæ¨¡å‹
- `backend/models/chat.py` - ä¼šè¯æ¨¡å‹ï¼ˆå·²æ·»åŠ tenant_idï¼‰
- `backend/models/document.py` - æ–‡æ¡£æ¨¡å‹ï¼ˆå·²æ·»åŠ tenant_idï¼‰

#### è®¤è¯æœåŠ¡
- `backend/services/auth_service.py` - è®¤è¯æ ¸å¿ƒé€»è¾‘
- `backend/services/oauth_providers.py` - OAuthæä¾›å•†ï¼ˆæ¡†æ¶ï¼‰
- `backend/middleware/auth_middleware.py` - è®¤è¯ä¸­é—´ä»¶

#### APIè·¯ç”±
- `backend/api/auth.py` - è®¤è¯APIï¼ˆ/register, /login, /oauthç­‰ï¼‰
- `backend/api/chat.py` - æ”¹é€ åæ”¯æŒç§Ÿæˆ·éš”ç¦»
- `backend/api/upload.py` - æ”¹é€ åæ”¯æŒç§Ÿæˆ·éš”ç¦»
- `backend/api/knowledge.py` - æ”¹é€ åæ”¯æŒç§Ÿæˆ·éš”ç¦»
- `backend/api/company.py` - æ”¹é€ åæ”¯æŒç§Ÿæˆ·éš”ç¦»
- `backend/api/recommendation.py` - æ”¹é€ åæ”¯æŒç§Ÿæˆ·éš”ç¦»

#### æ ¸å¿ƒé€»è¾‘
- `src/pipeline.py` - Pipelineæ”¯æŒtenant_idå‚æ•°
- `src/ingestion.py` - æ–‡æ¡£æ‘„å–æ”¯æŒç§Ÿæˆ·çº§ç´¢å¼•
- `src/questions_processing.py` - é—®é¢˜å¤„ç†æ”¯æŒç§Ÿæˆ·éš”ç¦»

#### æ•°æ®è¿ç§»
- `backend/migrations/add_user_system.py` - ç”¨æˆ·ç³»ç»Ÿè¿ç§»è„šæœ¬
- `backend/migrations/migrate_to_tenant_structure.py` - ç§Ÿæˆ·ç›®å½•è¿ç§»
- `quick_migrate.py` - å¿«é€Ÿè¿ç§»è„šæœ¬

### å‰ç«¯æ–‡ä»¶

#### é¡µé¢
- `frontend-next/app/login/page.tsx` - ç™»å½•/æ³¨å†Œé¡µé¢
- `frontend-next/app/oauth/callback/page.tsx` - OAuthå›è°ƒ
- `frontend-next/app/profile/page.tsx` - ç”¨æˆ·ä¸­å¿ƒ

#### æ ¸å¿ƒåº“
- `frontend-next/lib/api-v2.ts` - APIå®¢æˆ·ç«¯ï¼ˆTokenç®¡ç†+è‡ªåŠ¨åˆ·æ–°ï¼‰
- `frontend-next/middleware.ts` - è·¯ç”±å®ˆå«

### æ–‡æ¡£
- `docs/ç”¨æˆ·ç³»ç»Ÿå®æ–½æŒ‡å—.md` - å®æ–½æŒ‡å—
- `docs/ç”¨æˆ·ç³»ç»Ÿå¼€å‘æ€»ç»“.md` - åç«¯å¼€å‘æ€»ç»“
- `docs/å‰ç«¯ç”¨æˆ·ç³»ç»Ÿå¼€å‘å®ŒæˆæŠ¥å‘Š.md` - å‰ç«¯å¼€å‘æ€»ç»“
- `docs/ç”¨æˆ·ç³»ç»ŸAPIæ”¹é€ è¿›åº¦.md` - APIæ”¹é€ è¿›åº¦
- `docs/æ•°æ®è¿ç§»å®ŒæˆæŠ¥å‘Š.md` - æ•°æ®è¿ç§»æŠ¥å‘Š
- `docs/ç”¨æˆ·ç³»ç»Ÿå®Œæ•´å¼€å‘æ€»ç»“.md` - æœ¬æ–‡æ¡£

## ğŸ”„ å®Œæ•´ä¸šåŠ¡æµç¨‹

### ç”¨æˆ·æ³¨å†Œæµç¨‹
```
1. ç”¨æˆ·è®¿é—® /loginï¼Œåˆ‡æ¢åˆ°æ³¨å†Œæ¨¡å¼
2. å¡«å†™ç”¨æˆ·åã€å¯†ç ï¼ˆé‚®ç®±ã€æ‰‹æœºå·ã€å›¢é˜Ÿåå¯é€‰ï¼‰
3. ç‚¹å‡»"æ³¨å†Œ"
4. å‰ç«¯è°ƒç”¨ POST /api/v2/auth/register
5. åç«¯åˆ›å»ºï¼š
   - Tenantï¼ˆç§Ÿæˆ·ï¼‰
   - Roleï¼ˆç³»ç»Ÿè§’è‰²ï¼Œå¦‚ä¸å­˜åœ¨ï¼‰
   - Userï¼ˆç”¨æˆ·ï¼Œè§’è‰²ä¸ºadminï¼‰
6. æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨è°ƒç”¨ç™»å½•æ¥å£
7. è·å–Tokenå¹¶ä¿å­˜åˆ°localStorage
8. è·³è½¬åˆ°é¦–é¡µ
```

### ç”¨æˆ·ç™»å½•æµç¨‹
```
1. ç”¨æˆ·è®¿é—® /login
2. è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
3. å‰ç«¯è°ƒç”¨ POST /api/v2/auth/login
4. åç«¯éªŒè¯ï¼š
   - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
   - éªŒè¯å¯†ç ï¼ˆbcryptï¼‰
   - æ£€æŸ¥è´¦å·çŠ¶æ€
5. ç”ŸæˆTokenï¼š
   - Access Tokenï¼ˆJWTï¼Œ2å°æ—¶ï¼‰
   - Refresh Tokenï¼ˆéšæœºå­—ç¬¦ä¸²ï¼Œ7å¤©ï¼‰
6. è¿”å›Tokenå’Œç”¨æˆ·ä¿¡æ¯
7. å‰ç«¯ä¿å­˜åˆ°localStorage
8. è·³è½¬åˆ°é¦–é¡µ
```

### APIè°ƒç”¨æµç¨‹ï¼ˆå¸¦è®¤è¯ï¼‰
```
1. å‰ç«¯å‘èµ·APIè¯·æ±‚ï¼ˆå¦‚ GET /api/v2/chat/sessionsï¼‰
2. è¯·æ±‚æ‹¦æˆªå™¨è‡ªåŠ¨æ·»åŠ ï¼š
   Authorization: Bearer {access_token}
3. åç«¯è®¤è¯ä¸­é—´ä»¶éªŒè¯Tokenï¼š
   - è§£æJWT
   - éªŒè¯ç­¾åå’Œè¿‡æœŸæ—¶é—´
   - æå–user_idå’Œtenant_id
4. ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ˆå¸¦ç§Ÿæˆ·éš”ç¦»ï¼‰ï¼š
   - ä»…æŸ¥è¯¢/æ“ä½œå½“å‰tenant_idçš„æ•°æ®
5. è¿”å›ç»“æœ

ã€Tokenè¿‡æœŸå¤„ç†ã€‘
6. å¦‚æœè¿”å›401ï¼š
   - å“åº”æ‹¦æˆªå™¨æ•è·
   - ä½¿ç”¨refresh_tokenè°ƒç”¨ /api/v2/auth/refresh
   - è·å–æ–°access_token
   - æ›´æ–°localStorage
   - è‡ªåŠ¨é‡è¯•åŸè¯·æ±‚
7. å¦‚æœåˆ·æ–°å¤±è´¥ï¼š
   - æ¸…é™¤localStorage
   - è·³è½¬åˆ°ç™»å½•é¡µ
```

### ç§Ÿæˆ·çº§æ•°æ®æ£€ç´¢
```
1. ç”¨æˆ·æé—®
2. å‰ç«¯è°ƒç”¨ POST /api/v2/chat/ask
   å¸¦ä¸Štokenï¼ˆåŒ…å«tenant_idï¼‰
3. åç«¯æ¥æ”¶è¯·æ±‚ï¼Œä»tokenæå–tenant_id
4. Pipelineåˆå§‹åŒ–ï¼š
   Pipeline(scenario_id='tender', tenant_id='default-tenant')
5. è®¾ç½®ç§Ÿæˆ·çº§è·¯å¾„ï¼š
   - vector_db_dir = 'data/databases/vector_dbs/default-tenant/tender/'
   - bm25_dir = 'data/databases/bm25/default-tenant/tender/'
6. åŠ è½½ç´¢å¼•å¹¶æ£€ç´¢ï¼ˆä»…æœ¬ç§Ÿæˆ·æ•°æ®ï¼‰
7. ç”Ÿæˆç­”æ¡ˆå¹¶è¿”å›
```

## ğŸ¯ æµ‹è¯•æŒ‡å—

### 1. åç«¯APIæµ‹è¯•

#### ç”¨æˆ·æ³¨å†Œ
```bash
curl -X POST http://localhost:8000/api/v2/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "password123",
    "email": "test@example.com",
    "tenant_name": "æµ‹è¯•å›¢é˜Ÿ"
  }'
```

#### ç”¨æˆ·ç™»å½•
```bash
curl -X POST http://localhost:8000/api/v2/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "password123"
  }'

# è¿”å›ï¼š
{
  "data": {
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "refresh_token": "abc123...",
    "token_type": "bearer",
    "user": {...}
  }
}
```

#### è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è®¤è¯ï¼‰
```bash
curl -X GET http://localhost:8000/api/v2/auth/me \
  -H "Authorization: Bearer {access_token}"
```

#### è·å–ä¼šè¯åˆ—è¡¨ï¼ˆéœ€è®¤è¯ï¼Œç§Ÿæˆ·éš”ç¦»ï¼‰
```bash
curl -X GET http://localhost:8000/api/v2/chat/sessions \
  -H "Authorization: Bearer {access_token}"
```

### 2. å‰ç«¯åŠŸèƒ½æµ‹è¯•

#### è®¿é—®ç™»å½•é¡µ
```
http://localhost:3005/login
```

**æµ‹è¯•ç‚¹ï¼š**
- [ ] ç™»å½•è¡¨å•æ˜¾ç¤ºæ­£å¸¸
- [ ] æ³¨å†Œè¡¨å•åˆ‡æ¢æ­£å¸¸
- [ ] è¡¨å•éªŒè¯å·¥ä½œï¼ˆå¯†ç é•¿åº¦ç­‰ï¼‰
- [ ] OAuthæŒ‰é’®æ˜¾ç¤º

#### æµ‹è¯•æ³¨å†Œ
**æ­¥éª¤ï¼š**
1. ç‚¹å‡»"æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ"
2. å¡«å†™ç”¨æˆ·å: `testuser`
3. å¡«å†™å¯†ç : `password123`
4. ç‚¹å‡»"æ³¨å†Œ"

**é¢„æœŸï¼š**
- [ ] æ³¨å†ŒæˆåŠŸ
- [ ] è‡ªåŠ¨ç™»å½•
- [ ] è·³è½¬åˆ°é¦–é¡µ
- [ ] localStorageåŒ…å«access_tokenå’Œrefresh_token

#### æµ‹è¯•ç™»å½•
**æ­¥éª¤ï¼š**
1. è¾“å…¥ç”¨æˆ·å: `admin`
2. è¾“å…¥å¯†ç : `admin123`
3. ç‚¹å‡»"ç™»å½•"

**é¢„æœŸï¼š**
- [ ] ç™»å½•æˆåŠŸ
- [ ] è·³è½¬åˆ°é¦–é¡µ
- [ ] Tokenä¿å­˜æˆåŠŸ

#### æµ‹è¯•ç”¨æˆ·ä¸­å¿ƒ
**æ­¥éª¤ï¼š**
1. ç™»å½•åè®¿é—® `http://localhost:3005/profile`

**é¢„æœŸï¼š**
- [ ] æ˜¾ç¤ºç”¨æˆ·å
- [ ] æ˜¾ç¤ºè§’è‰²
- [ ] æ˜¾ç¤ºç§Ÿæˆ·ID
- [ ] "é€€å‡ºç™»å½•"æŒ‰é’®å¯ç”¨

#### æµ‹è¯•Tokenåˆ·æ–°
**æ­¥éª¤ï¼š**
1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
2. ä¿®æ”¹localStorageä¸­çš„access_tokenä¸ºè¿‡æœŸtoken
3. å‘èµ·ä»»æ„APIè¯·æ±‚ï¼ˆå¦‚åˆ·æ–°é¡µé¢ï¼‰

**é¢„æœŸï¼š**
- [ ] è‡ªåŠ¨è°ƒç”¨refreshæ¥å£
- [ ] è·å–æ–°Token
- [ ] è¯·æ±‚æˆåŠŸå®Œæˆ
- [ ] ä¸ä¼šè·³è½¬åˆ°ç™»å½•é¡µ

### 3. ç§Ÿæˆ·éš”ç¦»æµ‹è¯•

#### åˆ›å»ºä¸¤ä¸ªç§Ÿæˆ·çš„ç”¨æˆ·
```bash
# ç§Ÿæˆ·1
curl -X POST http://localhost:8000/api/v2/auth/register \
  -d '{"username":"tenant1","password":"pass123","tenant_name":"ç§Ÿæˆ·1"}'

# ç§Ÿæˆ·2
curl -X POST http://localhost:8000/api/v2/auth/register \
  -d '{"username":"tenant2","password":"pass123","tenant_name":"ç§Ÿæˆ·2"}'
```

#### ç§Ÿæˆ·1åˆ›å»ºä¼šè¯
```bash
# ç™»å½•è·å–token1
TOKEN1=$(curl -X POST ... | jq -r '.data.access_token')

# åˆ›å»ºä¼šè¯
curl -X POST http://localhost:8000/api/v2/chat/sessions \
  -H "Authorization: Bearer $TOKEN1" \
  -d '{"scenario_id":"tender","title":"ç§Ÿæˆ·1çš„ä¼šè¯"}'
```

#### ç§Ÿæˆ·2åˆ›å»ºä¼šè¯
```bash
# ç™»å½•è·å–token2
TOKEN2=$(curl -X POST ... | jq -r '.data.access_token')

# åˆ›å»ºä¼šè¯
curl -X POST http://localhost:8000/api/v2/chat/sessions \
  -H "Authorization: Bearer $TOKEN2" \
  -d '{"scenario_id":"tender","title":"ç§Ÿæˆ·2çš„ä¼šè¯"}'
```

#### éªŒè¯éš”ç¦»æ€§
```bash
# ç§Ÿæˆ·1æŸ¥è¯¢ä¼šè¯
curl -X GET http://localhost:8000/api/v2/chat/sessions \
  -H "Authorization: Bearer $TOKEN1"
# åº”è¯¥åªçœ‹åˆ°"ç§Ÿæˆ·1çš„ä¼šè¯"

# ç§Ÿæˆ·2æŸ¥è¯¢ä¼šè¯
curl -X GET http://localhost:8000/api/v2/chat/sessions \
  -H "Authorization: Bearer $TOKEN2"
# åº”è¯¥åªçœ‹åˆ°"ç§Ÿæˆ·2çš„ä¼šè¯"
```

## ğŸš€ éƒ¨ç½²æŒ‡å—

### 1. ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š
```bash
# æ•°æ®åº“
DATABASE_URL=sqlite:///./data/stock_data/databases/stock_rag.db

# JWTå¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼ï¼‰
JWT_SECRET_KEY=your-super-secret-key-change-in-production
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=120
JWT_REFRESH_TOKEN_EXPIRE_DAYS=7

# å¾®ä¿¡OAuthï¼ˆå¯é€‰ï¼‰
WECHAT_APP_ID=your-wechat-app-id
WECHAT_APP_SECRET=your-wechat-app-secret

# é’‰é’‰OAuthï¼ˆå¯é€‰ï¼‰
DINGTALK_APP_ID=your-dingtalk-app-id
DINGTALK_APP_SECRET=your-dingtalk-app-secret

# çŸ­ä¿¡æœåŠ¡ï¼ˆå¯é€‰ï¼‰
SMS_ACCESS_KEY_ID=your-aliyun-access-key-id
SMS_ACCESS_KEY_SECRET=your-aliyun-access-key-secret
```

### 2. æ•°æ®åº“åˆå§‹åŒ–

```bash
# è¿è¡Œè¿ç§»è„šæœ¬
python backend/migrations/add_user_system.py

# è¿ç§»ç°æœ‰æ•°æ®åˆ°ç§Ÿæˆ·ç›®å½•
python quick_migrate.py --force
```

### 3. å¯åŠ¨æœåŠ¡

```bash
# å®Œæ•´ç³»ç»Ÿå¯åŠ¨
python .\start_system.py

# æˆ–å•ç‹¬å¯åŠ¨åç«¯
cd backend
uvicorn main_multi_scenario:app --host 0.0.0.0 --port 8000

# æˆ–å•ç‹¬å¯åŠ¨å‰ç«¯
cd frontend-next
npm run dev -- -p 3005
```

### 4. åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜

è¿ç§»è„šæœ¬å·²è‡ªåŠ¨åˆ›å»ºï¼š
- ç”¨æˆ·å: `admin`
- å¯†ç : `admin123`
- è§’è‰²: ç®¡ç†å‘˜
- ç§Ÿæˆ·: `default-tenant`

**âš ï¸ ç”Ÿäº§ç¯å¢ƒè¯·ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç ï¼**

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“ä¼˜åŒ–
- âœ… å·²æ·»åŠ ç´¢å¼•ï¼š
  - `ix_session_tenant_user` - ä¼šè¯ç§Ÿæˆ·ç”¨æˆ·è”åˆç´¢å¼•
  - `ix_document_tenant` - æ–‡æ¡£ç§Ÿæˆ·ç´¢å¼•
  - `ix_oauth_provider_user` - OAuthå”¯ä¸€çº¦æŸç´¢å¼•

### 2. ç¼“å­˜ä¼˜åŒ–
- â³ å»ºè®®å®ç°ï¼š
  - Redisç¼“å­˜TokenéªŒè¯ç»“æœ
  - ç¼“å­˜åœºæ™¯é…ç½®
  - ç¼“å­˜ç”¨æˆ·æƒé™ä¿¡æ¯

### 3. å‘é‡æ£€ç´¢ä¼˜åŒ–
- âœ… å·²å®ç°ç§Ÿæˆ·çº§ç´¢å¼•éš”ç¦»
- â³ å»ºè®®ä¼˜åŒ–ï¼š
  - ç´¢å¼•é¢„åŠ è½½
  - çƒ­æ•°æ®ç¼“å­˜

## âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹

### å·²å®ç°
- âœ… å¯†ç bcryptåŠ å¯†
- âœ… JWT Tokenè®¤è¯
- âœ… OAuth Stateé˜²CSRF
- âœ… Tokenè‡ªåŠ¨åˆ·æ–°
- âœ… ç§Ÿæˆ·æ•°æ®éš”ç¦»

### å¾…åŠ å¼º
- â³ httpOnly Cookieå­˜å‚¨Token
- â³ HTTPSå¼ºåˆ¶
- â³ å¯†ç å¼ºåº¦ç­–ç•¥
- â³ è´¦å·é”å®šæœºåˆ¶ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
- â³ IPç™½åå•
- â³ åŒå› ç´ è®¤è¯

## ğŸ“Š ä¸‹ä¸€æ­¥è§„åˆ’

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰
1. **OAuthé…ç½®å®Œæˆ**
   - ç”³è¯·å¾®ä¿¡å¼€æ”¾å¹³å°è´¦å·
   - ç”³è¯·é’‰é’‰å¼€æ”¾å¹³å°è´¦å·
   - é…ç½®å›è°ƒURLå’Œå¯†é’¥

2. **ç”Ÿäº§ç¯å¢ƒå‡†å¤‡**
   - å¯ç”¨è·¯ç”±å®ˆå«
   - é…ç½®httpOnly Cookie
   - HTTPSè¯ä¹¦ç”³è¯·

3. **åŠŸèƒ½å®Œå–„**
   - ä¿®æ”¹å¯†ç 
   - é‚®ç®±éªŒè¯
   - æ‰¾å›å¯†ç 

### ä¸­æœŸï¼ˆ1ä¸ªæœˆï¼‰
1. **æƒé™ç»†åŒ–**
   - èµ„æºçº§æƒé™æ§åˆ¶
   - è‡ªå®šä¹‰è§’è‰²ç®¡ç†

2. **å®¡è®¡æ—¥å¿—**
   - ç™»å½•æ—¥å¿—
   - æ“ä½œæ—¥å¿—
   - æ•°æ®å˜æ›´è®°å½•

3. **ç§Ÿæˆ·ç®¡ç†**
   - ç§Ÿæˆ·é…é¢ç®¡ç†
   - ä½¿ç”¨ç»Ÿè®¡
   - è®¡è´¹ç³»ç»Ÿ

### é•¿æœŸï¼ˆ3ä¸ªæœˆï¼‰
1. **é«˜çº§è®¤è¯**
   - SSOé›†æˆï¼ˆLDAP/SAMLï¼‰
   - åŒå› ç´ è®¤è¯
   - ç”Ÿç‰©è¯†åˆ«

2. **æ•°æ®å…±äº«**
   - è·¨ç§Ÿæˆ·æ•°æ®å…±äº«æœºåˆ¶
   - æ•°æ®æƒé™ç²¾ç»†æ§åˆ¶

3. **APIæ‰©å±•**
   - APIå¯†é’¥ç®¡ç†
   - Webhookæ”¯æŒ
   - ç¬¬ä¸‰æ–¹é›†æˆSDK

## âœ… æ€»ç»“

### æ ¸å¿ƒæˆå°±
1. **å®Œæ•´çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿ** - æ³¨å†Œã€ç™»å½•ã€OAuthæ¡†æ¶å…¨éƒ¨å®Œæˆ
2. **å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»** - ä»APIåˆ°æ•°æ®åº“å†åˆ°å‘é‡ç´¢å¼•ï¼Œå…¨é“¾è·¯éš”ç¦»
3. **è‡ªåŠ¨åŒ–Tokenç®¡ç†** - å‰ç«¯æ‹¦æˆªå™¨å®ç°æ— æ„ŸçŸ¥åˆ·æ–°
4. **æƒé™ç®¡ç†åŸºç¡€** - RBACæ¨¡å‹ï¼Œå¯æ‰©å±•çš„è§’è‰²ç³»ç»Ÿ
5. **æ•°æ®è¿ç§»å®Œæˆ** - ç°æœ‰æ•°æ®å·²è¿ç§»åˆ°ç§Ÿæˆ·çº§ç›®å½•

### æŠ€æœ¯äº®ç‚¹
- âœ¨ JWT + Refresh TokenåŒTokenæœºåˆ¶
- âœ¨ ç§Ÿæˆ·çº§å‘é‡æ•°æ®åº“éš”ç¦»
- âœ¨ OAuth 2.0æ ‡å‡†æµç¨‹
- âœ¨ å‰ç«¯è‡ªåŠ¨Tokenåˆ·æ–°
- âœ¨ å¯é…ç½®çš„æ•°æ®å…±äº«ç­–ç•¥

### ç³»ç»ŸçŠ¶æ€
**å½“å‰ç³»ç»Ÿå·²å…·å¤‡å®Œæ•´çš„ç”¨æˆ·è®¤è¯å’Œå¤šç§Ÿæˆ·èƒ½åŠ›ï¼Œæ ¸å¿ƒåŠŸèƒ½å…¨éƒ¨å®Œæˆï¼Œå¯ä»¥æŠ•å…¥æµ‹è¯•å’Œè¯•è¿è¡Œã€‚**

---

**å¼€å‘å®Œæˆæ—¶é—´**: 2025-10-16
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**ç»´æŠ¤å›¢é˜Ÿ**: AI Assistant
