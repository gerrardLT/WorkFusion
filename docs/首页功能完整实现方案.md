# 首页功能完整实现方案

## 📋 概述

本文档详细说明首页需要实现的所有功能，包括搜索、上传进度、消息操作、会话管理、Markdown渲染以及移除所有硬编码数据。

---

## 🎯 需要实现的功能列表

### 1. ✅ 会话搜索功能
**状态**: 待实现
**优先级**: 高

**功能描述**:
- 在左侧边栏搜索框中输入关键词
- 实时过滤会话列表
- 支持按会话标题搜索
- 搜索结果高亮显示

**实现方式**:
```typescript
const [searchQuery, setSearchQuery] = useState('');

// 过滤会话
const filteredSessions = apiSessions.filter(session =>
  session.title.toLowerCase().includes(searchQuery.toLowerCase())
);
```

---

### 2. ✅ 文件上传进度条
**状态**: 待实现
**优先级**: 高

**功能描述**:
- 显示文件上传百分比
- 显示文件名和大小
- 上传完成后自动消失
- 上传失败时显示错误信息

**实现方式**:
```typescript
const [uploadProgress, setUploadProgress] = useState<{[key: string]: number}>({});

const handleFileUpload = async (files: FileList | null) => {
  if (!files || !currentScenario) return;

  for (const file of Array.from(files)) {
    const fileId = generateId();
    setUploadProgress(prev => ({ ...prev, [fileId]: 0 }));

    try {
      await uploadFile(file, currentScenario.id, file.name, (progress) => {
        setUploadProgress(prev => ({ ...prev, [fileId]: progress }));
      });

      // 上传完成，延迟移除进度
      setTimeout(() => {
        setUploadProgress(prev => {
          const newProgress = { ...prev };
          delete newProgress[fileId];
          return newProgress;
        });
      }, 2000);
    } catch (error) {
      console.error('上传失败:', error);
      setUploadProgress(prev => {
        const newProgress = { ...prev };
        delete newProgress[fileId];
        return newProgress;
      });
    }
  }
};
```

---

### 3. ✅ 复制消息功能
**状态**: 待实现
**优先级**: 中

**功能描述**:
- 在消息上悬停显示操作按钮
- 点击复制按钮复制消息内容
- 复制成功后显示提示

**实现方式**:
```typescript
const handleCopyMessage = async (content: string) => {
  try {
    await navigator.clipboard.writeText(content);
    // 显示成功提示
    alert('已复制到剪贴板');
  } catch (error) {
    console.error('复制失败:', error);
  }
};
```

---

### 4. ✅ 重新生成功能
**状态**: 待实现
**优先级**: 中

**功能描述**:
- 在AI消息上显示"重新生成"按钮
- 点击后重新发送上一条用户消息
- 替换当前AI回复

**实现方式**:
```typescript
const handleRegenerateMessage = async (messageId: string) => {
  // 找到对应的用户消息
  const messageIndex = messages.findIndex(m => m.id === messageId);
  if (messageIndex <= 0) return;

  const userMessage = messages[messageIndex - 1];

  // 移除当前AI回复
  setMessages(prev => prev.filter(m => m.id !== messageId));

  // 重新发送问题
  await handleSendMessage(userMessage.content, true);
};
```

---

### 5. ✅ 编辑消息功能
**状态**: 可选
**优先级**: 低

**功能描述**:
- 双击用户消息进入编辑模式
- 修改后重新发送
- 更新消息历史

---

### 6. ✅ 删除消息功能
**状态**: 可选
**优先级**: 低

**功能描述**:
- 在消息上显示删除按钮
- 确认后删除消息
- 删除用户消息时同时删除对应的AI回复

---

### 7. ✅ 会话重命名功能
**状态**: 待实现
**优先级**: 高

**功能描述**:
- 点击会话标题进入编辑模式
- 修改标题后自动保存
- 调用API更新会话标题

**实现方式**:
```typescript
const [editingSessionId, setEditingSessionId] = useState<string | null>(null);
const [editingSessionTitle, setEditingSessionTitle] = useState('');

const handleRenameSession = async (sessionId: string, newTitle: string) => {
  try {
    await updateSession(sessionId, { title: newTitle });
    await loadSessions();
    setEditingSessionId(null);
  } catch (error) {
    console.error('重命名失败:', error);
  }
};
```

---

### 8. ✅ Markdown渲染
**状态**: 待实现
**优先级**: 高

**功能描述**:
- AI回复支持Markdown格式
- 代码块语法高亮
- 支持表格、列表等格式

**实现方式**:
```typescript
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import rehypeHighlight from 'rehype-highlight';

// 在消息渲染中
<ReactMarkdown
  remarkPlugins={[remarkGfm]}
  rehypePlugins={[rehypeHighlight]}
  className="prose prose-invert max-w-none"
>
  {message.content}
</ReactMarkdown>
```

---

### 9. ✅ 场景切换功能
**状态**: 待实现
**优先级**: 最高

**功能描述**:
- 从API加载场景列表
- 显示所有可用场景
- 切换场景时重新加载会话和预设问题
- 场景配置存储到localStorage

**当前问题**:
- 场景列表使用硬编码
- 未从API加载场景配置

**实现方式**:
```typescript
const [availableScenarios, setAvailableScenarios] = useState<any[]>([]);

// 加载场景列表
useEffect(() => {
  const loadScenarios = async () => {
    try {
      const response = await getScenarios();
      setAvailableScenarios(response.scenarios || []);
    } catch (error) {
      console.error('加载场景失败:', error);
    }
  };
  loadScenarios();
}, []);

// 场景切换
const handleScenarioChange = async (scenarioId: string) => {
  switchScenario(scenarioId);
  setShowScenarioDropdown(false);
  setCurrentApiSession(null);
  setMessages([]);
  await loadSessions();

  // 加载新场景的预设问题
  try {
    const questions = await getPresetQuestions(scenarioId);
    setPresetQuestions(questions);
  } catch (error) {
    console.error('加载预设问题失败:', error);
  }
};
```

---

### 10. ✅ 移除硬编码数据
**状态**: 待实现
**优先级**: 最高

**需要移除的硬编码**:

#### 10.1 会话列表
**当前**:
```typescript
{/* 通用问答 - 激活状态 */}
{/* 其他会话示例 */}
{[
  { title: '合同审核（行政）', time: '12', status: '昨天', avatar: 'conv-2-avatar-56586a.png' },
  { title: '预算编制（财务）', time: '8', status: '周一', avatar: 'conv-3-avatar-56586a.png' },
  { title: '供应商评估（采购）', time: '3', status: '上周', avatar: 'conv-4-avatar-56586a.png' },
  { title: '巡检标准（运维）', time: '6', status: '上周', avatar: 'conv-5-avatar-56586a.png' }
].map((item, idx) => (
  // ...
))}
```

**改为**:
```typescript
{filteredSessions.map((session) => (
  <div
    key={session.id}
    onClick={() => selectChat(session)}
    className={cn(
      "group relative px-3 py-2.5 rounded-xl cursor-pointer transition-all",
      currentApiSession?.id === session.id
        ? "bg-[rgba(99, 102, 241, 0.16)]"
        : "bg-[#0D1B2A] hover:bg-[#111827]"
    )}
  >
    <div className="flex items-center gap-2">
      <NextImage
        src="/images/conv-1-avatar-56586a.png"  {/* 可以根据session类型动态选择 */}
        alt={session.title}
        width={32}
        height={32}
        className="rounded-full flex-shrink-0"
      />
      <div className="flex-1 min-w-0">
        {editingSessionId === session.id ? (
          <input
            type="text"
            value={editingSessionTitle}
            onChange={(e) => setEditingSessionTitle(e.target.value)}
            onBlur={() => handleRenameSession(session.id, editingSessionTitle)}
            onKeyDown={(e) => {
              if (e.key === 'Enter') {
                handleRenameSession(session.id, editingSessionTitle);
              }
            }}
            className="w-full bg-transparent border-none outline-none text-white"
            autoFocus
          />
        ) : (
          <p
            onDoubleClick={() => {
              setEditingSessionId(session.id);
              setEditingSessionTitle(session.title);
            }}
            style={{
              fontFamily: 'WenQuanYi Zen Hei, sans-serif',
              fontSize: '14px',
              fontWeight: 600,
              color: currentApiSession?.id === session.id ? '#EEF2FF' : '#DDE9FF'
            }}
          >
            {session.title}
          </p>
        )}
        <p style={{
          fontFamily: 'Inter, sans-serif',
          fontSize: '12px',
          color: '#9CA3AF'
        }}>
          {formatTime(session.updated_at)} • {session.message_count || 0} 条消息
        </p>
      </div>
    </div>
  </div>
))}
```

#### 10.2 预设问题
**当前**:
```typescript
const presetQuestions = [
  { text: '这份文档主要讲什么？', tag: '快速总结' },
  { text: '列出关键要点', tag: '要点清单' },
  { text: '有哪些风险或空白？', tag: '潜在问题' }
];
```

**改为**:
```typescript
const [presetQuestions, setPresetQuestions] = useState<string[]>([]);

useEffect(() => {
  const loadPresetQuestions = async () => {
    if (!currentScenario) return;
    try {
      const questions = await getPresetQuestions(currentScenario.id);
      setPresetQuestions(questions);
    } catch (error) {
      console.error('加载预设问题失败:', error);
    }
  };
  loadPresetQuestions();
}, [currentScenario]);
```

#### 10.3 场景下拉列表
**当前**:
```typescript
{(scenarioState.availableScenarios || []).map((scenario: any) => (
  // ...
))}
```

这部分已经使用了状态中的数据，但需要确保从API加载。

---

## 📝 实现步骤

### 第一步：添加新的状态
```typescript
// 搜索相关
const [searchQuery, setSearchQuery] = useState('');

// 上传进度相关
const [uploadProgress, setUploadProgress] = useState<{[key: string]: {
  progress: number;
  fileName: string;
  fileSize: number;
}}>({});

// 编辑相关
const [editingSessionId, setEditingSessionId] = useState<string | null>(null);
const [editingSessionTitle, setEditingSessionTitle] = useState('');
const [editingMessageId, setEditingMessageId] = useState<string | null>(null);

// 消息操作
const [hoveredMessageId, setHoveredMessageId] = useState<string | null>(null);

// 场景相关
const [availableScenarios, setAvailableScenarios] = useState<any[]>([]);
const [presetQuestions, setPresetQuestions] = useState<string[]>([]);
```

### 第二步：添加新的函数
```typescript
// 搜索函数
const filteredSessions = useMemo(() => {
  if (!searchQuery.trim()) return apiSessions;
  return apiSessions.filter(session =>
    session.title.toLowerCase().includes(searchQuery.toLowerCase())
  );
}, [apiSessions, searchQuery]);

// 复制消息
const handleCopyMessage = async (content: string) => {
  try {
    await navigator.clipboard.writeText(content);
    // TODO: 添加成功提示
  } catch (error) {
    console.error('复制失败:', error);
  }
};

// 重新生成
const handleRegenerateMessage = async (messageId: string) => {
  const messageIndex = messages.findIndex(m => m.id === messageId);
  if (messageIndex <= 0) return;

  const userMessage = messages[messageIndex - 1];
  setMessages(prev => prev.filter(m => m.id !== messageId));
  await handleSendMessage(userMessage.content, true);
};

// 重命名会话
const handleRenameSession = async (sessionId: string, newTitle: string) => {
  try {
    await updateSession(sessionId, { title: newTitle });
    await loadSessions();
    setEditingSessionId(null);
  } catch (error) {
    console.error('重命名失败:', error);
  }
};

// 删除消息
const handleDeleteMessage = (messageId: string) => {
  setMessages(prev => prev.filter(m => m.id !== messageId));
};

// 格式化时间
const formatTime = (timestamp: string) => {
  const now = new Date();
  const date = new Date(timestamp);
  const diffMs = now.getTime() - date.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return '今天';
  if (diffDays === 1) return '昨天';
  if (diffDays < 7) return `${diffDays}天前`;
  return date.toLocaleDateString();
};
```

### 第三步：更新useEffect
```typescript
// 加载场景列表
useEffect(() => {
  const loadScenarios = async () => {
    try {
      const response = await getScenarios();
      setAvailableScenarios(response.scenarios || []);
    } catch (error) {
      console.error('加载场景失败:', error);
    }
  };
  loadScenarios();
}, []);

// 加载预设问题
useEffect(() => {
  const loadPresetQuestions = async () => {
    if (!currentScenario) return;
    try {
      const questions = await getPresetQuestions(currentScenario.id);
      setPresetQuestions(questions);
    } catch (error) {
      console.error('加载预设问题失败:', error);
      // 使用默认问题
      setPresetQuestions([
        '这份文档主要讲什么？',
        '列出关键要点',
        '有哪些风险或空白？'
      ]);
    }
  };
  loadPresetQuestions();
}, [currentScenario]);

// 当场景切换时重新加载会话
useEffect(() => {
  if (currentScenario) {
    loadSessions();
  }
}, [currentScenario]);
```

### 第四步：更新JSX渲染

#### 4.1 搜索框
```tsx
<input
  type="text"
  placeholder="搜索会话..."
  value={searchQuery}
  onChange={(e) => setSearchQuery(e.target.value)}
  className="..."
/>
```

#### 4.2 会话列表
使用 `filteredSessions` 替代硬编码数据

#### 4.3 消息显示
```tsx
{msg.role === 'assistant' ? (
  <div className="relative group">
    <ReactMarkdown
      remarkPlugins={[remarkGfm]}
      rehypePlugins={[rehypeHighlight]}
      className="prose prose-invert max-w-none"
    >
      {msg.content}
    </ReactMarkdown>

    {/* 操作按钮 */}
    <div className="absolute top-0 right-0 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
      <button
        onClick={() => handleCopyMessage(msg.content)}
        className="p-1 bg-gray-700 rounded hover:bg-gray-600"
        title="复制"
      >
        <svg width="16" height="16" viewBox="0 0 16 16" fill="white">
          {/* 复制图标 */}
        </svg>
      </button>
      <button
        onClick={() => handleRegenerateMessage(msg.id)}
        className="p-1 bg-gray-700 rounded hover:bg-gray-600"
        title="重新生成"
      >
        <svg width="16" height="16" viewBox="0 0 16 16" fill="white">
          {/* 刷新图标 */}
        </svg>
      </button>
    </div>
  </div>
) : (
  <p>{msg.content}</p>
)}
```

#### 4.4 上传进度
```tsx
{/* 上传进度显示 */}
{Object.keys(uploadProgress).length > 0 && (
  <div className="fixed bottom-4 right-4 space-y-2">
    {Object.entries(uploadProgress).map(([fileId, info]) => (
      <div key={fileId} className="bg-gray-800 p-4 rounded-lg shadow-lg min-w-[300px]">
        <div className="flex justify-between items-center mb-2">
          <span className="text-sm text-white truncate">{info.fileName}</span>
          <span className="text-xs text-gray-400">{info.progress}%</span>
        </div>
        <div className="w-full bg-gray-700 rounded-full h-2">
          <div
            className="bg-blue-500 h-2 rounded-full transition-all"
            style={{ width: `${info.progress}%` }}
          />
        </div>
      </div>
    ))}
  </div>
)}
```

#### 4.5 场景下拉菜单
```tsx
{showScenarioDropdown && (
  <div className="absolute top-full mt-2 right-0 bg-[#0D1B2A] border border-[#2A2F3A] rounded-xl z-50 min-w-[150px]">
    {availableScenarios.map((scenario: any) => (
      <button
        key={scenario.id}
        onClick={() => handleScenarioChange(scenario.id)}
        className={cn(
          "w-full text-left px-4 py-2 hover:bg-[#111827] transition-colors",
          currentScenario?.id === scenario.id && "bg-[#111827]"
        )}
        style={{
          fontFamily: 'WenQuanYi Zen Hei, sans-serif',
          fontSize: '14px',
          color: currentScenario?.id === scenario.id ? '#CFE8FF' : '#9CA3AF'
        }}
      >
        {scenario.name}
      </button>
    ))}
  </div>
)}
```

#### 4.6 预设问题
```tsx
{presetQuestions.map((question, idx) => (
  <span
    key={idx}
    onClick={() => handlePresetQuestion(question)}
    style={{...}}
  >
    {question}
  </span>
))}
```

---

## 🎉 完成后的效果

1. ✅ **搜索功能** - 实时搜索会话
2. ✅ **上传进度** - 美观的进度条显示
3. ✅ **消息操作** - 复制、重新生成、删除
4. ✅ **会话重命名** - 双击编辑会话标题
5. ✅ **Markdown渲染** - 格式化的AI回复
6. ✅ **场景切换** - 真实的场景数据
7. ✅ **无硬编码** - 所有数据来自API

---

**文档版本**: 1.0
**最后更新**: 2025-10-16

